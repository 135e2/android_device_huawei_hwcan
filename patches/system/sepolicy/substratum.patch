From 31bc744f98417d462e0afc83710058a94cf50106 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?M=C3=A5rten=20Kongstad?= <marten.kongstad@sonymobile.com>
Date: Mon, 22 Jun 2015 09:31:25 +0200
Subject: [PATCH 01/13] OMS7-N: Add service 'overlay' to service_contexts

The 'overlay' service is the Overlay Manager Service, which tracks
packages and their Runtime Resource Overlay overlay packages.

Bug: 31052947

Co-authored-by: Martin Wallgren <martin.wallgren@sonymobile.com>
Signed-off-by: Zoran Jovanovic <zoran.jovanovic@sonymobile.com>

Change-Id: Ie996707dd02166325271bee49163ac263e560a1d
---
 service.te       | 1 +
 service_contexts | 1 +
 system_server.te | 1 +
 3 files changed, 3 insertions(+)

diff --git a/service.te b/service.te
index 9a77ce27..a8d16c22 100644
--- a/service.te
+++ b/service.te
@@ -81,6 +81,7 @@ type network_score_service, system_api_service, system_server_service, service_m
 type network_time_update_service, system_server_service, service_manager_type;
 type notification_service, app_api_service, system_server_service, service_manager_type;
 type otadexopt_service, system_server_service, service_manager_type;
+type overlay_service, app_api_service, system_server_service, service_manager_type;
 type package_service, app_api_service, system_server_service, service_manager_type;
 type permission_service, app_api_service, system_server_service, service_manager_type;
 type persistent_data_block_service, system_api_service, system_server_service, service_manager_type;
diff --git a/service_contexts b/service_contexts
index fffbd4d3..19cf907e 100644
--- a/service_contexts
+++ b/service_contexts
@@ -93,6 +93,7 @@ network_time_update_service               u:object_r:network_time_update_service
 nfc                                       u:object_r:nfc_service:s0
 notification                              u:object_r:notification_service:s0
 otadexopt                                 u:object_r:otadexopt_service:s0
+overlay                                   u:object_r:overlay_service:s0
 package                                   u:object_r:package_service:s0
 permission                                u:object_r:permission_service:s0
 persistent_data_block                     u:object_r:persistent_data_block_service:s0
diff --git a/system_server.te b/system_server.te
index db59b657..2b93dc2f 100644
--- a/system_server.te
+++ b/system_server.te
@@ -438,6 +438,7 @@ allow system_server mediacodec_service:service_manager find;
 allow system_server mediadrmserver_service:service_manager find;
 allow system_server netd_service:service_manager find;
 allow system_server nfc_service:service_manager find;
+allow system_server overlay_service:service_manager find;
 allow system_server radio_service:service_manager find;
 allow system_server system_server_service:service_manager { add find };
 allow system_server surfaceflinger_service:service_manager find;

From 0ea49532ba00921f60010ec5f88975fa2aba9f3f Mon Sep 17 00:00:00 2001
From: d34d <clark@cyngn.com>
Date: Wed, 4 Jan 2017 10:29:34 -0800
Subject: [PATCH 02/13] Introduce sepolicy exceptions for theme assets

Assets such as composed icons and ringtones need to be accessed
by apps. This patch adds the policy needed to facilitate this.

Change-Id: I0420de579aed0cff5add181cd0a8bf0f2b05d723
---
 app.te         | 4 ++++
 bootanim.te    | 4 ++++
 file.te        | 3 +++
 file_contexts  | 3 +++
 mediaserver.te | 4 ++++
 system_app.te  | 4 ++++
 zygote.te      | 4 ++++
 7 files changed, 26 insertions(+)

diff --git a/app.te b/app.te
index 19a7dacb..3a2878de 100644
--- a/app.te
+++ b/app.te
@@ -468,3 +468,7 @@ neverallow {
 # Foreign dex profiles are just markers. Prevent apps to do anything but touch them.
 neverallow appdomain user_profile_foreign_dex_data_file:file rw_file_perms;
 neverallow appdomain user_profile_foreign_dex_data_file:dir { open getattr read ioctl remove_name };
+
+# Themed resources (i.e. composed icons)
+allow appdomain theme_data_file:dir r_dir_perms;
+allow appdomain theme_data_file:file r_file_perms;
diff --git a/bootanim.te b/bootanim.te
index c3091ab4..3ae9478b 100644
--- a/bootanim.te
+++ b/bootanim.te
@@ -32,3 +32,7 @@ r_dir_file(bootanim, cgroup)
 
 # System file accesses.
 allow bootanim system_file:dir r_dir_perms;
+
+# Themed resources (bootanimation)
+allow bootanim theme_data_file:dir search;
+allow bootanim theme_data_file:file r_file_perms;
diff --git a/file.te b/file.te
index 446c1829..07bdff1f 100644
--- a/file.te
+++ b/file.te
@@ -267,3 +267,6 @@ allow postinstall_file self:filesystem associate;
 # Should be:
 #   type apk_data_file, file_type, data_file_type;
 neverallow fs_type file_type:filesystem associate;
+
+# Themes
+type theme_data_file, file_type, data_file_type;
diff --git a/file_contexts b/file_contexts
index 085a57bb..fefa9d77 100644
--- a/file_contexts
+++ b/file_contexts
@@ -402,3 +402,6 @@
 /mnt/user(/.*)?             u:object_r:mnt_user_file:s0
 /mnt/runtime(/.*)?          u:object_r:storage_file:s0
 /storage(/.*)?              u:object_r:storage_file:s0
+
+# Themes
+/data/system/theme(/.*)?  u:object_r:theme_data_file:s0
diff --git a/mediaserver.te b/mediaserver.te
index dc05e14b..661bdee7 100644
--- a/mediaserver.te
+++ b/mediaserver.te
@@ -139,3 +139,7 @@ neverallow mediaserver { file_type fs_type }:file execute_no_trans;
 
 # do not allow privileged socket ioctl commands
 neverallowxperm mediaserver domain:{ rawip_socket tcp_socket udp_socket } ioctl priv_sock_ioctls;
+
+# Themed resources (i.e. composed icons)
+allow mediaserver theme_data_file:dir r_dir_perms;
+allow mediaserver theme_data_file:file r_file_perms;
diff --git a/system_app.te b/system_app.te
index 50320c5c..afd65d7a 100644
--- a/system_app.te
+++ b/system_app.te
@@ -75,3 +75,7 @@ allow system_app sysfs_zram:dir search;
 allow system_app sysfs_zram:file r_file_perms;
 
 control_logd(system_app)
+
+# Themes
+allow system_app theme_data_file:dir create_dir_perms;
+allow system_app theme_data_file:file create_file_perms;
diff --git a/zygote.te b/zygote.te
index c6b343cd..c650c178 100644
--- a/zygote.te
+++ b/zygote.te
@@ -104,3 +104,7 @@ neverallow zygote {
   data_file_type
   -dalvikcache_data_file # map PROT_EXEC
 }:file no_x_file_perms;
+
+# Themes
+allow zygote theme_data_file:file r_file_perms;
+allow zygote theme_data_file:dir r_dir_perms;

From 8f172596ec848977699136a18bfd4bdc1fec25ff Mon Sep 17 00:00:00 2001
From: bigrushdog <randall.rushing@gmail.com>
Date: Wed, 4 Jan 2017 10:31:29 -0800
Subject: [PATCH 03/13] sepolicy: fix themed boot animation

W BootAnimation: type=1400 audit(0.0:42): avc: denied { open } for uid=1003 path="/data/system/theme/bootanimation.zip" dev="mmcblk0p42" ino=1657697 scontext=u:r:bootanim:s0 tcontext=u:object_r:system_data_file:s0 tclass=file permissive=0

W         : Unable to open '/data/system/theme/bootanimation.zip': Permission denied

W zipro   : Error opening archive /data/system/theme/bootanimation.zip: I/O Error

Change-Id: I1440bd967d7a06ee64ea861a2544b54caf909f23
---
 bootanim.te | 1 +
 1 file changed, 1 insertion(+)

diff --git a/bootanim.te b/bootanim.te
index 3ae9478b..2356d818 100644
--- a/bootanim.te
+++ b/bootanim.te
@@ -36,3 +36,4 @@ allow bootanim system_file:dir r_dir_perms;
 # Themed resources (bootanimation)
 allow bootanim theme_data_file:dir search;
 allow bootanim theme_data_file:file r_file_perms;
+allow bootanim system_data_file:file open;

From 3a5b4a296a31f531440692ee1f47622490a21128 Mon Sep 17 00:00:00 2001
From: George G <kreach3r@users.noreply.github.com>
Date: Wed, 8 Feb 2017 17:22:44 +0200
Subject: [PATCH 04/13] sepolicy: fix themed sounds

02-08 17:26:48.011 18259-18259/? W/SoundPoolThread: type=1400 audit(0.0:31): avc: denied { read } for path="/data/system/theme/audio/ui/Lock.ogg" dev="dm-0" ino=1006317 scontext=u:r:drmserver:s0 tcontext=u:object_r:theme_data_file:s0 tclass=file permissive=0

Change-Id: If96d784d4a79e7c7f7d21d191c2e0795c366e03a
---
 drmserver.te | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drmserver.te b/drmserver.te
index 9130e0b4..6d3883f3 100644
--- a/drmserver.te
+++ b/drmserver.te
@@ -54,3 +54,7 @@ allow drmserver drmserver_service:service_manager { add find };
 allow drmserver permission_service:service_manager find;
 
 selinux_check_access(drmserver)
+
+# Themed resources (i.e. composed icons)
+allow drmserver theme_data_file:dir r_dir_perms;
+allow drmserver theme_data_file:file r_file_perms;

From 780255c5f5a41c4602a1e80ad162a9416bcb4879 Mon Sep 17 00:00:00 2001
From: Surge1223 <surge1223@gmail.com>
Date: Sat, 18 Feb 2017 08:46:15 -0600
Subject: [PATCH 05/13] initial policy edits for masquerade to operate rootless

Change-Id: Iddfc408f206033772b9d49d335ca94e63b5e5210
---
 app.te           |  2 +-
 domain.te        |  2 ++
 masquerade.te    | 50 ++++++++++++++++++++++++++++++++++++++++++++++++++
 seapp_contexts   |  1 +
 untrusted_app.te |  3 +++
 5 files changed, 57 insertions(+), 1 deletion(-)
 create mode 100644 masquerade.te

diff --git a/app.te b/app.te
index 3a2878de..661f67f0 100644
--- a/app.te
+++ b/app.te
@@ -374,7 +374,7 @@ neverallow appdomain exec_type:file
 # This is the default type for anything under /data not otherwise
 # specified in file_contexts.  Define a different type for portions
 # that should be writable by apps.
-neverallow appdomain system_data_file:dir_file_class_set
+neverallow { appdomain -masquerade_app } system_data_file:dir_file_class_set
     { create write setattr relabelfrom relabelto append unlink link rename };
 
 # Write to various other parts of /data.
diff --git a/domain.te b/domain.te
index 59de1f12..f7ce7151 100644
--- a/domain.te
+++ b/domain.te
@@ -385,6 +385,7 @@ neverallow {
   -init # TODO: limit init to relabelfrom for files
   -zygote
   -installd
+  -masquerade_app
   -postinstall_dexopt
   -cppreopts
   -dex2oat
@@ -491,6 +492,7 @@ neverallow {
   -system_server
   -system_app
   -init
+  -masquerade_app
   -installd # for relabelfrom and unlink, check for this in explicit neverallow
 } system_data_file:file no_w_file_perms;
 # do not grant anything greater than r_file_perms and relabelfrom unlink
diff --git a/masquerade.te b/masquerade.te
new file mode 100644
index 00000000..433448a5
--- /dev/null
+++ b/masquerade.te
@@ -0,0 +1,50 @@
+#
+# Masquerade needs additional permissions when not running with system_server
+# masquerade.substratum.
+#
+#
+type masquerade_app, domain;
+
+# Add masquerade to domains
+net_domain(masquerade_app)
+app_domain(masquerade_app)
+binder_service(masquerade_app)
+
+# Modify system dalvik-cache
+allow masquerade_app dalvikcache_data_file:file {  getattr open read  };
+allow masquerade_app dalvikcache_data_file:dir { getattr search  };
+
+# Read and write /data/data subdirectory.
+allow masquerade_app system_app_data_file:dir create_dir_perms;
+allow masquerade_app system_app_data_file:{ file lnk_file } create_file_perms;
+
+# /data/resource-cache
+allow masquerade_app resourcecache_data_file:file r_file_perms;
+allow masquerade_app resourcecache_data_file:dir r_dir_perms;
+
+# Read wallpaper file.
+allow masquerade_app wallpaper_file:file r_file_perms;
+
+# Read icon file.
+allow masquerade_app icon_file:file r_file_perms;
+
+# Set bootanimation
+allow masquerade_app bootanim:process { getsched setsched };
+
+# Backup of wallpaper imagery uses temporary hard links to avoid data churn
+allow masquerade_app { system_data_file wallpaper_file }:file link;
+
+# Manage ringtones.
+allow masquerade_app ringtone_file:dir { create_dir_perms relabelto };
+allow masquerade_app ringtone_file:file create_file_perms;
+
+# Manage overlays
+allow masquerade_app overlay_service:service_manager find;
+
+# System file accesses.
+allow masquerade_app system_file:dir r_dir_perms;
+allow masquerade_app system_file:dir rmdir;
+allow masquerade_app kernel:system module_request;
+allow masquerade_app dalvikcache_data_file:file { setattr write };
+allow masquerade_app system_data_file:dir { add_name create rmdir remove_name setattr write };
+allow masquerade_app system_data_file:file { create getattr setattr unlink write };
diff --git a/seapp_contexts b/seapp_contexts
index 5d5ad751..85303d07 100644
--- a/seapp_contexts
+++ b/seapp_contexts
@@ -97,3 +97,4 @@ user=_app seinfo=platform domain=platform_app type=app_data_file levelFrom=user
 user=_app isAutoPlayApp=true domain=autoplay_app type=autoplay_data_file levelFrom=all
 user=_app isPrivApp=true domain=priv_app type=app_data_file levelFrom=user
 user=_app domain=untrusted_app type=app_data_file levelFrom=user
+user=system isPrivApp=true domain=masquerade_app seinfo=platform name=masquerade.substratum type=system_app_data_file
diff --git a/untrusted_app.te b/untrusted_app.te
index 07bfbf4c..452c5313 100644
--- a/untrusted_app.te
+++ b/untrusted_app.te
@@ -110,6 +110,9 @@ allow untrusted_app sysfs_hwrandom:file r_file_perms;
 allow untrusted_app preloads_data_file:dir r_dir_perms;
 allow untrusted_app preloads_data_file:file r_file_perms;
 
+# Allow AOPT to call module_request
+allow untrusted_app kernel:system module_request;
+
 ###
 ### neverallow rules
 ###

From a17805485de96c4251b18ad64c23c3661c43570c Mon Sep 17 00:00:00 2001
From: Surge1223 <surge1223@gmail.com>
Date: Tue, 21 Feb 2017 12:28:05 -0600
Subject: [PATCH 06/13] sepolicy: rename masquerade domain and allow JobService
 in system_server

This attempts to address the issue of JobService being unable to process
overlays when selinux is set to enforcing.

I ActivityManager: Start proc 7323:masquerade.substratum/1000 for service
masquerade.substratum/.services.JobService
I ActivityManager: Setting hasTopUi=true for pid=1473
D PhoneStatusBar: disable: < expand ICONS* alerts SYSTEM_INFO* back home recent clock search quick_settings
E SELinux : avc:  denied  { find } for service=activity pid=7323 uid=1000
scontext=u:r:masquerade_app:s0tcontext=u:object_r:activity_service:s0 tclass=service_manager permissive=0
D AndroidRuntime: Shutting down VM
E AndroidRuntime: FATAL EXCEPTION: main
E AndroidRuntime: PID: 7323

Change-Id: Ia274f14a2fdb77970b3142f4587036502943882c
---
 app.te           |  2 +-
 domain.te        |  4 ++--
 masquerade.te    | 49 +++++++++++++++++++++++++------------------------
 seapp_contexts   |  2 +-
 service.te       |  1 +
 service_contexts |  1 +
 system_server.te |  1 +
 7 files changed, 32 insertions(+), 28 deletions(-)

diff --git a/app.te b/app.te
index 661f67f0..e6180e35 100644
--- a/app.te
+++ b/app.te
@@ -374,7 +374,7 @@ neverallow appdomain exec_type:file
 # This is the default type for anything under /data not otherwise
 # specified in file_contexts.  Define a different type for portions
 # that should be writable by apps.
-neverallow { appdomain -masquerade_app } system_data_file:dir_file_class_set
+neverallow { appdomain -masquerade } system_data_file:dir_file_class_set
     { create write setattr relabelfrom relabelto append unlink link rename };
 
 # Write to various other parts of /data.
diff --git a/domain.te b/domain.te
index f7ce7151..b473da76 100644
--- a/domain.te
+++ b/domain.te
@@ -385,7 +385,7 @@ neverallow {
   -init # TODO: limit init to relabelfrom for files
   -zygote
   -installd
-  -masquerade_app
+  -masquerade
   -postinstall_dexopt
   -cppreopts
   -dex2oat
@@ -492,7 +492,7 @@ neverallow {
   -system_server
   -system_app
   -init
-  -masquerade_app
+  -masquerade
   -installd # for relabelfrom and unlink, check for this in explicit neverallow
 } system_data_file:file no_w_file_perms;
 # do not grant anything greater than r_file_perms and relabelfrom unlink
diff --git a/masquerade.te b/masquerade.te
index 433448a5..949699c1 100644
--- a/masquerade.te
+++ b/masquerade.te
@@ -3,48 +3,49 @@
 # masquerade.substratum.
 #
 #
-type masquerade_app, domain;
+type masquerade, domain;
 
 # Add masquerade to domains
-net_domain(masquerade_app)
-app_domain(masquerade_app)
-binder_service(masquerade_app)
+net_domain(masquerade)
+app_domain(masquerade)
+binder_service(masquerade)
 
 # Modify system dalvik-cache
-allow masquerade_app dalvikcache_data_file:file {  getattr open read  };
-allow masquerade_app dalvikcache_data_file:dir { getattr search  };
+allow masquerade dalvikcache_data_file:file {  getattr open read  };
+allow masquerade dalvikcache_data_file:dir { getattr search  };
 
 # Read and write /data/data subdirectory.
-allow masquerade_app system_app_data_file:dir create_dir_perms;
-allow masquerade_app system_app_data_file:{ file lnk_file } create_file_perms;
+allow masquerade system_app_data_file:dir create_dir_perms;
+allow masquerade system_app_data_file:{ file lnk_file } create_file_perms;
 
 # /data/resource-cache
-allow masquerade_app resourcecache_data_file:file r_file_perms;
-allow masquerade_app resourcecache_data_file:dir r_dir_perms;
+allow masquerade resourcecache_data_file:file r_file_perms;
+allow masquerade resourcecache_data_file:dir r_dir_perms;
 
 # Read wallpaper file.
-allow masquerade_app wallpaper_file:file r_file_perms;
+allow masquerade wallpaper_file:file r_file_perms;
 
 # Read icon file.
-allow masquerade_app icon_file:file r_file_perms;
+allow masquerade icon_file:file r_file_perms;
 
 # Set bootanimation
-allow masquerade_app bootanim:process { getsched setsched };
+allow masquerade bootanim:process { getsched setsched };
 
 # Backup of wallpaper imagery uses temporary hard links to avoid data churn
-allow masquerade_app { system_data_file wallpaper_file }:file link;
+allow masquerade { system_data_file wallpaper_file }:file link;
 
 # Manage ringtones.
-allow masquerade_app ringtone_file:dir { create_dir_perms relabelto };
-allow masquerade_app ringtone_file:file create_file_perms;
+allow masquerade ringtone_file:dir { create_dir_perms relabelto };
+allow masquerade ringtone_file:file create_file_perms;
 
-# Manage overlays
-allow masquerade_app overlay_service:service_manager find;
+# Manage overlays and start JobService
+allow masquerade overlay_service:service_manager find;
+allow masquerade activity_service:service_manager find;
 
 # System file accesses.
-allow masquerade_app system_file:dir r_dir_perms;
-allow masquerade_app system_file:dir rmdir;
-allow masquerade_app kernel:system module_request;
-allow masquerade_app dalvikcache_data_file:file { setattr write };
-allow masquerade_app system_data_file:dir { add_name create rmdir remove_name setattr write };
-allow masquerade_app system_data_file:file { create getattr setattr unlink write };
+allow masquerade system_file:dir r_dir_perms;
+allow masquerade system_file:dir rmdir;
+allow masquerade kernel:system module_request;
+allow masquerade dalvikcache_data_file:file { setattr write };
+allow masquerade system_data_file:dir { add_name create rmdir remove_name setattr write };
+allow masquerade system_data_file:file { create getattr setattr unlink write read };
diff --git a/seapp_contexts b/seapp_contexts
index 85303d07..bbf8b781 100644
--- a/seapp_contexts
+++ b/seapp_contexts
@@ -97,4 +97,4 @@ user=_app seinfo=platform domain=platform_app type=app_data_file levelFrom=user
 user=_app isAutoPlayApp=true domain=autoplay_app type=autoplay_data_file levelFrom=all
 user=_app isPrivApp=true domain=priv_app type=app_data_file levelFrom=user
 user=_app domain=untrusted_app type=app_data_file levelFrom=user
-user=system isPrivApp=true domain=masquerade_app seinfo=platform name=masquerade.substratum type=system_app_data_file
+user=system isPrivApp=true domain=masquerade seinfo=platform name=masquerade.substratum type=system_app_data_file
diff --git a/service.te b/service.te
index a8d16c22..782201f9 100644
--- a/service.te
+++ b/service.te
@@ -68,6 +68,7 @@ type jobscheduler_service, app_api_service, system_server_service, service_manag
 type launcherapps_service, app_api_service, system_server_service, service_manager_type;
 type location_service, app_api_service, system_server_service, service_manager_type;
 type lock_settings_service, system_api_service, system_server_service, service_manager_type;
+type masquerade_service, app_api_service, system_server_service, service_manager_type;
 type media_projection_service, app_api_service, system_server_service, service_manager_type;
 type media_router_service, app_api_service, system_server_service, service_manager_type;
 type media_session_service, app_api_service, system_server_service, service_manager_type;
diff --git a/service_contexts b/service_contexts
index 19cf907e..77b508e3 100644
--- a/service_contexts
+++ b/service_contexts
@@ -65,6 +65,7 @@ jobscheduler                              u:object_r:jobscheduler_service:s0
 launcherapps                              u:object_r:launcherapps_service:s0
 location                                  u:object_r:location_service:s0
 lock_settings                             u:object_r:lock_settings_service:s0
+masquerade                                u:object_r:masquerade_service:s0
 media.audio_flinger                       u:object_r:audioserver_service:s0
 media.audio_policy                        u:object_r:audioserver_service:s0
 media.camera                              u:object_r:cameraserver_service:s0
diff --git a/system_server.te b/system_server.te
index 2b93dc2f..32a9600a 100644
--- a/system_server.te
+++ b/system_server.te
@@ -432,6 +432,7 @@ allow system_server batteryproperties_service:service_manager find;
 allow system_server keystore_service:service_manager find;
 allow system_server gatekeeper_service:service_manager find;
 allow system_server fingerprintd_service:service_manager find;
+allow system_server masquerade_service:service_manager find;
 allow system_server mediaserver_service:service_manager find;
 allow system_server mediaextractor_service:service_manager find;
 allow system_server mediacodec_service:service_manager find;

From 119beb64989750547924613abc797ffe3bd38316 Mon Sep 17 00:00:00 2001
From: Surge1223 <surge1223@gmail.com>
Date: Wed, 22 Feb 2017 20:45:04 -0600
Subject: [PATCH 07/13] sepolicy: allow masquerade to read and write theme
 assets

Fix for masquerade to handle theme assets including fonts and bootanimation, also
takes into account when /data/system/theme doesnt exist

SELinux : avc: denied { find } for service=display pid=10652 uid=1000 scontext=u:r:masquerade:s0
tcontext=u:object_r:display_service:s0 tclass=service_manager permissive=0

Change-Id: I1136f9965a85d9c9f19827200e61e4d1c9724593
---
 masquerade.te | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/masquerade.te b/masquerade.te
index 949699c1..2f17030a 100644
--- a/masquerade.te
+++ b/masquerade.te
@@ -49,3 +49,15 @@ allow masquerade kernel:system module_request;
 allow masquerade dalvikcache_data_file:file { setattr write };
 allow masquerade system_data_file:dir { add_name create rmdir remove_name setattr write };
 allow masquerade system_data_file:file { create getattr setattr unlink write read };
+
+# Allow handling of theme assets
+allow masquerade theme_data_file:dir { add_name create remove_name setattr write rmdir };
+allow masquerade theme_data_file:file { create setattr write unlink };
+
+# Modify system properties
+allow masquerade init:unix_stream_socket connectto;
+allow masquerade mount_service:service_manager find;
+allow masquerade property_socket:sock_file write;
+allow masquerade system_prop:property_service set;
+allow masquerade connectivity_service:service_manager find;
+allow masquerade display_service:service_manager find;

From afa0b7306ae002e1f706170d5ff88a18a2272aab Mon Sep 17 00:00:00 2001
From: Miccia <bono.michele94@gmail.com>
Date: Mon, 27 Feb 2017 12:36:21 +0100
Subject: [PATCH 08/13] sepolicy: Fix application of bootanimation

Change-Id: I7365d28fecf18b4d1aa42b2210e023b202dd97a5
---
 masquerade.te    | 5 +++++
 system_server.te | 2 ++
 2 files changed, 7 insertions(+)

diff --git a/masquerade.te b/masquerade.te
index 2f17030a..0cbbdb2a 100644
--- a/masquerade.te
+++ b/masquerade.te
@@ -61,3 +61,8 @@ allow masquerade property_socket:sock_file write;
 allow masquerade system_prop:property_service set;
 allow masquerade connectivity_service:service_manager find;
 allow masquerade display_service:service_manager find;
+
+allow masquerade media_rw_data_file:dir { search write };
+allow masquerade media_rw_data_file:file { open unlink };
+allow masquerade network_management_service:service_manager find;
+allow masquerade media_rw_data_file:dir remove_name;
diff --git a/system_server.te b/system_server.te
index 32a9600a..e25a98c3 100644
--- a/system_server.te
+++ b/system_server.te
@@ -577,3 +577,5 @@ neverallow system_server { dev_type -frp_block_device }:blk_file no_rw_file_perm
 neverallow system_server self:process execmem;
 neverallow system_server ashmem_device:chr_file execute;
 neverallow system_server system_server_tmpfs:file execute;
+
+allow system_server theme_data_file:dir search;

From 6a70eaa79c33ee1310f20698db43cd3e89090317 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Wed, 1 Mar 2017 23:11:49 +0100
Subject: [PATCH 09/13] sepolicy: Redo masquerade rules

* Use macros
* Label custom properties
* Reorder rules alphabetically

Change-Id: I6ea45271d64dfbe373104e8f6637b95150fa0dbb
---
 masquerade.te     | 41 ++++++++++++++++++-----------------------
 property.te       |  1 +
 property_contexts |  1 +
 system_server.te  |  8 ++++++--
 4 files changed, 26 insertions(+), 25 deletions(-)

diff --git a/masquerade.te b/masquerade.te
index 0cbbdb2a..6fbc5e1e 100644
--- a/masquerade.te
+++ b/masquerade.te
@@ -11,16 +11,15 @@ app_domain(masquerade)
 binder_service(masquerade)
 
 # Modify system dalvik-cache
-allow masquerade dalvikcache_data_file:file {  getattr open read  };
-allow masquerade dalvikcache_data_file:dir { getattr search  };
+allow masquerade dalvikcache_data_file:dir r_dir_perms;
+allow masquerade dalvikcache_data_file:file rw_file_perms;
 
 # Read and write /data/data subdirectory.
 allow masquerade system_app_data_file:dir create_dir_perms;
 allow masquerade system_app_data_file:{ file lnk_file } create_file_perms;
 
 # /data/resource-cache
-allow masquerade resourcecache_data_file:file r_file_perms;
-allow masquerade resourcecache_data_file:dir r_dir_perms;
+r_dir_file(masquerade, resourcecache_data_file)
 
 # Read wallpaper file.
 allow masquerade wallpaper_file:file r_file_perms;
@@ -38,31 +37,27 @@ allow masquerade { system_data_file wallpaper_file }:file link;
 allow masquerade ringtone_file:dir { create_dir_perms relabelto };
 allow masquerade ringtone_file:file create_file_perms;
 
-# Manage overlays and start JobService
-allow masquerade overlay_service:service_manager find;
-allow masquerade activity_service:service_manager find;
-
 # System file accesses.
-allow masquerade system_file:dir r_dir_perms;
-allow masquerade system_file:dir rmdir;
 allow masquerade kernel:system module_request;
-allow masquerade dalvikcache_data_file:file { setattr write };
-allow masquerade system_data_file:dir { add_name create rmdir remove_name setattr write };
-allow masquerade system_data_file:file { create getattr setattr unlink write read };
+allow masquerade system_data_file:dir create_dir_perms;
+allow masquerade system_data_file:file create_file_perms;
+allow masquerade system_file:dir { r_dir_perms rmdir };
 
 # Allow handling of theme assets
-allow masquerade theme_data_file:dir { add_name create remove_name setattr write rmdir };
-allow masquerade theme_data_file:file { create setattr write unlink };
+allow masquerade theme_data_file:dir create_dir_perms;
+allow masquerade theme_data_file:file create_file_perms;
 
 # Modify system properties
-allow masquerade init:unix_stream_socket connectto;
-allow masquerade mount_service:service_manager find;
-allow masquerade property_socket:sock_file write;
-allow masquerade system_prop:property_service set;
+set_prop(masquerade, theme_prop)
+
+# Edit files in /sdcard
+allow masquerade media_rw_data_file:dir rw_dir_perms;
+allow masquerade media_rw_data_file:file rw_file_perms;
+
+# Services
+allow masquerade activity_service:service_manager find;
 allow masquerade connectivity_service:service_manager find;
 allow masquerade display_service:service_manager find;
-
-allow masquerade media_rw_data_file:dir { search write };
-allow masquerade media_rw_data_file:file { open unlink };
+allow masquerade mount_service:service_manager find;
 allow masquerade network_management_service:service_manager find;
-allow masquerade media_rw_data_file:dir remove_name;
+allow masquerade overlay_service:service_manager find;
diff --git a/property.te b/property.te
index af7013f4..44f15bb9 100644
--- a/property.te
+++ b/property.te
@@ -38,5 +38,6 @@ type dalvik_prop, property_type, core_property_type;
 type config_prop, property_type, core_property_type;
 type device_logging_prop, property_type;
 type safemode_prop, property_type;
+type theme_prop, property_type;
 
 allow property_type tmpfs:filesystem associate;
diff --git a/property_contexts b/property_contexts
index 4368a989..0280e7a2 100644
--- a/property_contexts
+++ b/property_contexts
@@ -23,6 +23,7 @@ ro.hw.                  u:object_r:system_prop:s0
 sys.                    u:object_r:system_prop:s0
 sys.cppreopt            u:object_r:cppreopt_prop:s0
 sys.powerctl            u:object_r:powerctl_prop:s0
+sys.refresh_theme       u:object_r:theme_prop:s0
 sys.usb.ffs.            u:object_r:ffs_prop:s0
 service.                u:object_r:system_prop:s0
 wlan.                   u:object_r:system_prop:s0
diff --git a/system_server.te b/system_server.te
index e25a98c3..2aee375f 100644
--- a/system_server.te
+++ b/system_server.te
@@ -348,6 +348,9 @@ set_prop(system_server, ctl_bugreport_prop)
 # cppreopt property
 set_prop(system_server, cppreopt_prop)
 
+# theme property
+get_prop(system_server, theme_prop)
+
 # Create a socket for receiving info from wpa.
 type_transition system_server wifi_data_file:sock_file system_wpa_socket;
 type_transition system_server wpa_socket:sock_file system_wpa_socket;
@@ -526,6 +529,9 @@ allow system_server media_rw_data_file:dir search;
 # Allow invoking tools like "timeout"
 allow system_server toolbox_exec:file rx_file_perms;
 
+# Allow `search` in theme_data_file directory
+allow system_server theme_data_file:dir search;
+
 # Postinstall
 #
 # For OTA dexopt, allow calls coming from postinstall.
@@ -577,5 +583,3 @@ neverallow system_server { dev_type -frp_block_device }:blk_file no_rw_file_perm
 neverallow system_server self:process execmem;
 neverallow system_server ashmem_device:chr_file execute;
 neverallow system_server system_server_tmpfs:file execute;
-
-allow system_server theme_data_file:dir search;

From dc46b2ebae021dbd20f868a8e22c2ae219a81853 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <natechancellor@gmail.com>
Date: Sat, 4 Mar 2017 19:20:10 -0700
Subject: [PATCH 10/13] Welcome to Theme Interfacer! [2/2]

Change-Id: I4a28c8840957d385338529540e081eabd3135cc1
Signed-off-by: Nathan Chancellor <natechancellor@gmail.com>
---
 app.te           |  2 +-
 domain.te        |  4 ++--
 interfacer.te    | 63 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 masquerade.te    | 63 --------------------------------------------------------
 seapp_contexts   |  2 +-
 service.te       |  2 +-
 service_contexts |  2 +-
 system_server.te |  2 +-
 8 files changed, 70 insertions(+), 70 deletions(-)
 create mode 100644 interfacer.te
 delete mode 100644 masquerade.te

diff --git a/app.te b/app.te
index e6180e35..93fe3a4b 100644
--- a/app.te
+++ b/app.te
@@ -374,7 +374,7 @@ neverallow appdomain exec_type:file
 # This is the default type for anything under /data not otherwise
 # specified in file_contexts.  Define a different type for portions
 # that should be writable by apps.
-neverallow { appdomain -masquerade } system_data_file:dir_file_class_set
+neverallow { appdomain -interfacer } system_data_file:dir_file_class_set
     { create write setattr relabelfrom relabelto append unlink link rename };
 
 # Write to various other parts of /data.
diff --git a/domain.te b/domain.te
index b473da76..fbd6c266 100644
--- a/domain.te
+++ b/domain.te
@@ -385,7 +385,7 @@ neverallow {
   -init # TODO: limit init to relabelfrom for files
   -zygote
   -installd
-  -masquerade
+  -interfacer
   -postinstall_dexopt
   -cppreopts
   -dex2oat
@@ -492,7 +492,7 @@ neverallow {
   -system_server
   -system_app
   -init
-  -masquerade
+  -interfacer
   -installd # for relabelfrom and unlink, check for this in explicit neverallow
 } system_data_file:file no_w_file_perms;
 # do not grant anything greater than r_file_perms and relabelfrom unlink
diff --git a/interfacer.te b/interfacer.te
new file mode 100644
index 00000000..45dcd6b4
--- /dev/null
+++ b/interfacer.te
@@ -0,0 +1,63 @@
+#
+# Theme Interfacer needs additional permissions when not running with system_server
+# projekt.interfacer.
+#
+#
+type interfacer, domain;
+
+# Add Theme Interfacer to domains
+net_domain(interfacer)
+app_domain(interfacer)
+binder_service(interfacer)
+
+# Modify system dalvik-cache
+allow interfacer dalvikcache_data_file:dir r_dir_perms;
+allow interfacer dalvikcache_data_file:file rw_file_perms;
+
+# Read and write /data/data subdirectory.
+allow interfacer system_app_data_file:dir create_dir_perms;
+allow interfacer system_app_data_file:{ file lnk_file } create_file_perms;
+
+# /data/resource-cache
+r_dir_file(interfacer, resourcecache_data_file)
+
+# Read wallpaper file.
+allow interfacer wallpaper_file:file r_file_perms;
+
+# Read icon file.
+allow interfacer icon_file:file r_file_perms;
+
+# Set bootanimation
+allow interfacer bootanim:process { getsched setsched };
+
+# Backup of wallpaper imagery uses temporary hard links to avoid data churn
+allow interfacer { system_data_file wallpaper_file }:file link;
+
+# Manage ringtones.
+allow interfacer ringtone_file:dir { create_dir_perms relabelto };
+allow interfacer ringtone_file:file create_file_perms;
+
+# System file accesses.
+allow interfacer kernel:system module_request;
+allow interfacer system_data_file:dir create_dir_perms;
+allow interfacer system_data_file:file create_file_perms;
+allow interfacer system_file:dir { r_dir_perms rmdir };
+
+# Allow handling of theme assets
+allow interfacer theme_data_file:dir create_dir_perms;
+allow interfacer theme_data_file:file create_file_perms;
+
+# Modify system properties
+set_prop(interfacer, theme_prop)
+
+# Edit files in /sdcard
+allow interfacer media_rw_data_file:dir rw_dir_perms;
+allow interfacer media_rw_data_file:file rw_file_perms;
+
+# Services
+allow interfacer activity_service:service_manager find;
+allow interfacer connectivity_service:service_manager find;
+allow interfacer display_service:service_manager find;
+allow interfacer mount_service:service_manager find;
+allow interfacer network_management_service:service_manager find;
+allow interfacer overlay_service:service_manager find;
diff --git a/masquerade.te b/masquerade.te
deleted file mode 100644
index 6fbc5e1e..00000000
--- a/masquerade.te
+++ /dev/null
@@ -1,63 +0,0 @@
-#
-# Masquerade needs additional permissions when not running with system_server
-# masquerade.substratum.
-#
-#
-type masquerade, domain;
-
-# Add masquerade to domains
-net_domain(masquerade)
-app_domain(masquerade)
-binder_service(masquerade)
-
-# Modify system dalvik-cache
-allow masquerade dalvikcache_data_file:dir r_dir_perms;
-allow masquerade dalvikcache_data_file:file rw_file_perms;
-
-# Read and write /data/data subdirectory.
-allow masquerade system_app_data_file:dir create_dir_perms;
-allow masquerade system_app_data_file:{ file lnk_file } create_file_perms;
-
-# /data/resource-cache
-r_dir_file(masquerade, resourcecache_data_file)
-
-# Read wallpaper file.
-allow masquerade wallpaper_file:file r_file_perms;
-
-# Read icon file.
-allow masquerade icon_file:file r_file_perms;
-
-# Set bootanimation
-allow masquerade bootanim:process { getsched setsched };
-
-# Backup of wallpaper imagery uses temporary hard links to avoid data churn
-allow masquerade { system_data_file wallpaper_file }:file link;
-
-# Manage ringtones.
-allow masquerade ringtone_file:dir { create_dir_perms relabelto };
-allow masquerade ringtone_file:file create_file_perms;
-
-# System file accesses.
-allow masquerade kernel:system module_request;
-allow masquerade system_data_file:dir create_dir_perms;
-allow masquerade system_data_file:file create_file_perms;
-allow masquerade system_file:dir { r_dir_perms rmdir };
-
-# Allow handling of theme assets
-allow masquerade theme_data_file:dir create_dir_perms;
-allow masquerade theme_data_file:file create_file_perms;
-
-# Modify system properties
-set_prop(masquerade, theme_prop)
-
-# Edit files in /sdcard
-allow masquerade media_rw_data_file:dir rw_dir_perms;
-allow masquerade media_rw_data_file:file rw_file_perms;
-
-# Services
-allow masquerade activity_service:service_manager find;
-allow masquerade connectivity_service:service_manager find;
-allow masquerade display_service:service_manager find;
-allow masquerade mount_service:service_manager find;
-allow masquerade network_management_service:service_manager find;
-allow masquerade overlay_service:service_manager find;
diff --git a/seapp_contexts b/seapp_contexts
index bbf8b781..5dc518dc 100644
--- a/seapp_contexts
+++ b/seapp_contexts
@@ -97,4 +97,4 @@ user=_app seinfo=platform domain=platform_app type=app_data_file levelFrom=user
 user=_app isAutoPlayApp=true domain=autoplay_app type=autoplay_data_file levelFrom=all
 user=_app isPrivApp=true domain=priv_app type=app_data_file levelFrom=user
 user=_app domain=untrusted_app type=app_data_file levelFrom=user
-user=system isPrivApp=true domain=masquerade seinfo=platform name=masquerade.substratum type=system_app_data_file
+user=system isPrivApp=true domain=interfacer seinfo=platform name=projekt.interfacer type=system_app_data_file
diff --git a/service.te b/service.te
index 782201f9..884c6ba6 100644
--- a/service.te
+++ b/service.te
@@ -63,12 +63,12 @@ type hardware_properties_service, app_api_service, system_server_service, servic
 type hdmi_control_service, system_api_service, system_server_service, service_manager_type;
 type input_method_service, app_api_service, system_server_service, service_manager_type;
 type input_service, app_api_service, system_server_service, service_manager_type;
+type interfacer_service, app_api_service, system_server_service, service_manager_type;
 type imms_service, app_api_service, system_server_service, service_manager_type;
 type jobscheduler_service, app_api_service, system_server_service, service_manager_type;
 type launcherapps_service, app_api_service, system_server_service, service_manager_type;
 type location_service, app_api_service, system_server_service, service_manager_type;
 type lock_settings_service, system_api_service, system_server_service, service_manager_type;
-type masquerade_service, app_api_service, system_server_service, service_manager_type;
 type media_projection_service, app_api_service, system_server_service, service_manager_type;
 type media_router_service, app_api_service, system_server_service, service_manager_type;
 type media_session_service, app_api_service, system_server_service, service_manager_type;
diff --git a/service_contexts b/service_contexts
index 77b508e3..7112450d 100644
--- a/service_contexts
+++ b/service_contexts
@@ -57,6 +57,7 @@ iphonesubinfo2                            u:object_r:radio_service:s0
 iphonesubinfo                             u:object_r:radio_service:s0
 ims                                       u:object_r:radio_service:s0
 imms                                      u:object_r:imms_service:s0
+interfacer                                u:object_r:interfacer_service:s0
 isms_msim                                 u:object_r:radio_service:s0
 isms2                                     u:object_r:radio_service:s0
 isms                                      u:object_r:radio_service:s0
@@ -65,7 +66,6 @@ jobscheduler                              u:object_r:jobscheduler_service:s0
 launcherapps                              u:object_r:launcherapps_service:s0
 location                                  u:object_r:location_service:s0
 lock_settings                             u:object_r:lock_settings_service:s0
-masquerade                                u:object_r:masquerade_service:s0
 media.audio_flinger                       u:object_r:audioserver_service:s0
 media.audio_policy                        u:object_r:audioserver_service:s0
 media.camera                              u:object_r:cameraserver_service:s0
diff --git a/system_server.te b/system_server.te
index 2aee375f..056919f0 100644
--- a/system_server.te
+++ b/system_server.te
@@ -435,7 +435,7 @@ allow system_server batteryproperties_service:service_manager find;
 allow system_server keystore_service:service_manager find;
 allow system_server gatekeeper_service:service_manager find;
 allow system_server fingerprintd_service:service_manager find;
-allow system_server masquerade_service:service_manager find;
+allow system_server interfacer_service:service_manager find;
 allow system_server mediaserver_service:service_manager find;
 allow system_server mediaextractor_service:service_manager find;
 allow system_server mediacodec_service:service_manager find;

From f0b9b1f2546032b6484fc7d5ed1d7274f6fcb420 Mon Sep 17 00:00:00 2001
From: Surge Raval <Surge1223@gmail.com>
Date: Sun, 16 Apr 2017 05:00:13 +0000
Subject: [PATCH 11/13] sepolicy: add file and domain trans to interfacer

This will fix bootanimations not applying on 7.1.2 ROMs

Change-Id: I3dd752dcb58ee84ac9953252a1fb3c5cd84c90c7
---
 interfacer.te    | 5 +++++
 untrusted_app.te | 1 +
 2 files changed, 6 insertions(+)

diff --git a/interfacer.te b/interfacer.te
index 45dcd6b4..a5ba1d7c 100644
--- a/interfacer.te
+++ b/interfacer.te
@@ -61,3 +61,8 @@ allow interfacer display_service:service_manager find;
 allow interfacer mount_service:service_manager find;
 allow interfacer network_management_service:service_manager find;
 allow interfacer overlay_service:service_manager find;
+
+# Allow file and type transition for contexts
+type_transition interfacer system_data_file:file theme_data_file "theme";
+type_transition interfacer system_data_file:dir theme_data_file;
+file_type_auto_trans(interfacer, system_data_file, theme_data_file);
diff --git a/untrusted_app.te b/untrusted_app.te
index 452c5313..1089e61d 100644
--- a/untrusted_app.te
+++ b/untrusted_app.te
@@ -218,3 +218,4 @@ neverallow untrusted_app tun_device:chr_file open;
 # Only allow appending to /data/anr/traces.txt (b/27853304, b/18340553)
 neverallow untrusted_app anr_data_file:file ~{ open append };
 neverallow untrusted_app anr_data_file:dir ~search;
+allow untrusted_app system_app_data_file:dir getattr;

From 414ba807be204eb1f9f40ac83e575dae468cffb8 Mon Sep 17 00:00:00 2001
From: Harsh Shandilya <msfjarvis@gmail.com>
Date: Tue, 9 May 2017 09:18:10 +0530
Subject: [PATCH 12/13] sepolicy: Allow system_server to set theme_prop

[ 6065.716763] init: avc:  denied  { set } for property=sys.refresh_theme
pid=1131 uid=1000 gid=1000 scontext=u:r:system_server:s0
tcontext=u:object_r:theme_prop:s0 tclass=property_service permissive=0

I am yet to spot any regressions this is causing, but better safe than sorry

Change-Id: I971b92dd3c074cda2ba0b49ffd256679dc4086de
---
 system_server.te | 1 +
 1 file changed, 1 insertion(+)

diff --git a/system_server.te b/system_server.te
index 056919f0..4b00ede1 100644
--- a/system_server.te
+++ b/system_server.te
@@ -350,6 +350,7 @@ set_prop(system_server, cppreopt_prop)
 
 # theme property
 get_prop(system_server, theme_prop)
+set_prop(system_server, theme_prop)
 
 # Create a socket for receiving info from wpa.
 type_transition system_server wifi_data_file:sock_file system_wpa_socket;

From 2a5fcc60c164b0cb19506d58aa884b5a24dae1e7 Mon Sep 17 00:00:00 2001
From: Harsh Shandilya <msfjarvis@gmail.com>
Date: Sun, 16 Jul 2017 21:18:59 +0530
Subject: [PATCH 13/13] interfacer: Allow interfacer to find content_service

https://substratum.review/#/c/420/ implements a ContentObserver in
interfacer which requires interfacer to be able to find the content_service.

Change-Id: I1d8cabd9848807ea4dfafcf7123478da834ef5a5
---
 interfacer.te | 1 +
 1 file changed, 1 insertion(+)

diff --git a/interfacer.te b/interfacer.te
index a5ba1d7c..fc6921a4 100644
--- a/interfacer.te
+++ b/interfacer.te
@@ -57,6 +57,7 @@ allow interfacer media_rw_data_file:file rw_file_perms;
 # Services
 allow interfacer activity_service:service_manager find;
 allow interfacer connectivity_service:service_manager find;
+allow interfacer content_service:service_manager find;
 allow interfacer display_service:service_manager find;
 allow interfacer mount_service:service_manager find;
 allow interfacer network_management_service:service_manager find;

